<script>
const API_BASE = "http://127.0.0.1:8000";
const token = localStorage.getItem("token");
const username = localStorage.getItem("username") || "User";

// Departments
const DEPARTMENTS = [
  "Administration","Operations","Engineering","Maintenance","Systems (Signalling & Telecom)",
  "Electrical","Civil","Rolling Stock","Finance","Human Resources","IT","Security","Commercial",
  "Projects","Procurement","Stores","Safety & Quality","Public Relations","Legal","Customer Service"
];

// Roles
const ROLES = [
  "All Employees","Admin","Manager","Team Lead","Supervisor","Executive","Engineer",
  "Technician","HR Executive","Finance Officer","IT Support","Security Officer",
  "Contractor","Viewer","Uploader"
];

/* DOM refs */
const greet = document.getElementById("greet");
const logoutBtn = document.getElementById("logoutBtn");
const empName = document.getElementById("empName");
const empId = document.getElementById("empId");
const empRole = document.getElementById("empRole");
const notifications = document.getElementById("notifications");

const docsTbody = document.getElementById("docsTbody");
const msgBox = document.getElementById("msgBox");

const accessRoleSelect = document.getElementById("accessRole");
const uploadBtn = document.getElementById("uploadBtn");
const uploadMsg = document.getElementById("uploadMsg");
const fileInput = document.getElementById("fileInput");
const titleInput = document.getElementById("title");
const descInput = document.getElementById("description");

if (!token) {
  window.location.href = "login.html";
} else {
  greet.innerText = `ðŸ‘‹ Welcome, ${username}`;
}

/* fill selects */
ROLES.forEach(r=>accessRoleSelect.innerHTML += `<option>${r}</option>`);

logoutBtn.addEventListener("click", ()=>{
  localStorage.removeItem("token"); localStorage.removeItem("username");
  window.location.href = "login.html";
});

/* fetch employee details */
async function loadEmployeeDetails(){
  try {
    let res = await fetch(`${API_BASE}/auth/me`, { headers: { "Authorization": "Bearer " + token } });
    if(!res.ok){ res = await fetch(`${API_BASE}/users/me`, { headers: { "Authorization": "Bearer " + token } }); }
    if(res.ok){
      const u = await res.json();
      empName.innerText = u.full_name || u.username || username;
      empId.innerText = u.id || u.employee_id || "--";
      empRole.innerText = u.role || "--";
    }
  } catch(err){ console.warn("Employee details error:", err); empName.innerText = username; }
}

/* fetch notifications */
async function loadNotifications(){
  try {
    const res = await fetch(`${API_BASE}/notifications`, { headers: { "Authorization": "Bearer " + token } });
    if(res.ok){
      const list = await res.json();
      notifications.innerHTML = "";
      if(Array.isArray(list) && list.length){
        list.slice(0,6).forEach(n=>notifications.innerHTML += `<div class="note">${n.message || n}</div>`);
      } else notifications.innerHTML = `<div class="note">No new notifications</div>`;
    }
  } catch{ notifications.innerHTML = `<div class="note">No new notifications</div>`; }
}

/* fetch documents */
async function fetchDocuments(){
  docsTbody.innerHTML = `<tr><td class="no-data" colspan="5">Loadingâ€¦</td></tr>`;
  try {
    const res = await fetch(`${API_BASE}/documents/list`, { headers: { "Authorization": "Bearer " + token } });
    if(!res.ok){ docsTbody.innerHTML = `<tr><td class="no-data" colspan="5">Failed to load documents</td></tr>`; return; }
    const docs = await res.json();
    if(!docs.length){ docsTbody.innerHTML = `<tr><td class="no-data" colspan="5">No documents uploaded yet.</td></tr>`; return; }
    docsTbody.innerHTML = "";

    docs.forEach(d=>{
      const access = d.access_role || "â€”";
      const uploaded_by = d.uploaded_by || "â€”";
      let date = d.uploaded_at || "â€”";
      if(typeof date==="string" && date.includes("T")) date = date.split("T")[0];

      // Show delete button only if current user is uploader
      const deleteBtn = uploaded_by === username
        ? `<button class="deleteBtn" data-id="${d.id}" style="color:red; border:none; background:none; cursor:pointer">Delete</button>`
        : "";

      docsTbody.innerHTML += `
        <tr>
          <td>${escapeHtml(d.filename || d.title || "Unnamed")}</td>
          <td>${escapeHtml(access)}</td>
          <td>${escapeHtml(uploaded_by)}</td>
          <td>${escapeHtml(date)}</td>
          <td>
            <a href="document.html?id=${d.id}" target="_blank">Open</a>
            ${deleteBtn}
          </td>
        </tr>`;
    });

    // Attach delete handlers
    document.querySelectorAll(".deleteBtn").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const docId = btn.dataset.id;
        if(!confirm("Are you sure you want to delete this document?")) return;

        try {
          const res = await fetch(`${API_BASE}/documents/delete/${docId}`, {
            method: "DELETE",
            headers: { "Authorization": `Bearer ${token}` }
          });
          if(res.ok){
            alert("Document deleted successfully");
            fetchDocuments(); // refresh list
          } else {
            const err = await res.json().catch(()=>({detail:"Failed"}));
            alert("Error: " + (err.detail || res.statusText));
          }
        } catch(e){
          alert("Network error during deletion");
          console.error(e);
        }
      });
    });

  } catch(err){ docsTbody.innerHTML = `<tr><td class="no-data" colspan="5">Network error</td></tr>`; }
}

/* upload handler */
uploadBtn.addEventListener("click", async ()=>{
  const file = fileInput.files[0];
  if(!file){
    uploadMsg.innerText = "Please choose a file";
    uploadMsg.style.color="red";
    return;
  }

  const fd = new FormData();
  fd.append("file", file);
  fd.append("title", titleInput.value || file.name);
  fd.append("description", descInput.value || "");
  fd.append("access_role", accessRoleSelect.value);

  uploadBtn.disabled = true;
  uploadBtn.innerText = "Uploadingâ€¦";
  uploadMsg.innerText = "";

  try {
    const res = await fetch(`${API_BASE}/documents/upload`, {
      method: "POST",
      headers: { "Authorization": `Bearer ${token}` },
      body: fd
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      console.error("Upload error:", res.status, err);
      uploadMsg.innerText = "Upload failed: " + (err.detail || res.statusText);
      uploadMsg.style.color = "red";
      return;
    }

    const data = await res.json();
    uploadMsg.innerText = "âœ… Uploaded: " + (data.filename || file.name);
    uploadMsg.style.color = "green";

    fileInput.value = "";
    titleInput.value = "";
    descInput.value = "";

    fetchDocuments(); // reload docs list
  } catch (err) {
    console.error("Network error:", err);
    uploadMsg.innerText = "Network error during upload";
    uploadMsg.style.color = "red";
  } finally {
    uploadBtn.disabled = false;
    uploadBtn.innerText = "Upload";
  }
});

/* utils */
function escapeHtml(str){ return String(str||"").replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* init */
loadEmployeeDetails();
loadNotifications();
fetchDocuments();
</script>
