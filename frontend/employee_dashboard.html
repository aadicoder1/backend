<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KMRL SmartDocs - Employee Dashboard</title>
<style>
/* --------------------------
   Glassy theme + layered blurred background
   Colors: #92cce8, rgb(208,246,233), #2596BE, #B1D5E6, #bfe2f2
   Paste into <head> without changing HTML/JS
   -------------------------- */

:root{
  /* Update --bg-img if your file is at a different path.
     Try "/inm/blue.png" or "/img/blue.png" or "inm/blue.png" depending on your setup. */
  --bg-img: url("/inm/blue.png");

  --c1: #92cce8;
  --c2: rgb(208,246,233);
  --c3: #2596BE;
  --c4: #B1D5E6;
  --c5: #bfe2f2;

  --glass-strong: rgba(255,255,255,0.72);
  --glass-mid: rgba(255,255,255,0.58);
  --glass-weak: rgba(255,255,255,0.42);

  --card-radius: 12px;
  --gap: 18px;
}

/* page base */
html,body{
  height:100%;
  margin:0;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color:#0f1720;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  background: linear-gradient(135deg, var(--c5) 0%, var(--c2) 60%);
  overflow-x: hidden;
}

/* background image layers (back-most) */
body::before{
  content:"";
  position:fixed;
  inset:0;
  background-image: var(--bg-img);
  background-size:cover;
  background-position:center;
  background-repeat:no-repeat;

  /* strong blur for the base image */
  filter: blur(18px) saturate(1.05) contrast(1.02);
  transform: scale(1.03); /* avoid edge artifacts when blurring */
  z-index:-40;
  pointer-events:none;
}

/* subtle gradient overlay and slight extra blur */
body::after{
  content:"";
  position:fixed;
  inset:0;
  background: linear-gradient(135deg, rgba(37,150,190,0.08), rgba(146,204,232,0.06));
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index:-30;
  pointer-events:none;
}

/* layout spacing helpers (both pages use .layout or .container) */
.layout, .container {
  display: flex;
  gap: var(--gap);
  padding: var(--gap);
  align-items:flex-start;
  /* keep height flexible; HTML controls page height */
}

/* Topbar: gradient, soft shadow */
.topbar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 20px;
  background: linear-gradient(90deg, var(--c3), var(--c1));
  color: white;
  border-bottom-left-radius: 0;
  border-bottom-right-radius: 0;
  box-shadow: 0 8px 28px rgba(2,6,23,0.12);
  position: sticky;
  top: 0;
  z-index: 20;
}

/* Topbar button */
.topbar button, .btn {
  background: linear-gradient(135deg, var(--c3), var(--c1));
  color: white;
  border: none;
  padding:8px 12px;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  transition: transform .18s ease, box-shadow .18s ease;
}
.topbar button:hover, .btn:hover{ transform: translateY(-3px); box-shadow: 0 10px 30px rgba(37,150,190,0.16); }

/* Generic "glass" card styling - glassmorphism */
.card {
  --card-blur: 10px; /* default blur depth for this card */
  position: relative;
  background: linear-gradient(180deg, rgba(255,255,255,0.65), rgba(255,255,255,0.55));
  border: 1px solid rgba(255,255,255,0.35);
  border-radius: var(--card-radius);
  padding:16px;
  box-shadow: 0 8px 26px rgba(2,6,23,0.06);
  backdrop-filter: blur(var(--card-blur)) saturate(1.05);
  -webkit-backdrop-filter: blur(var(--card-blur)) saturate(1.05);
  transition: transform .18s ease, box-shadow .18s ease, background .25s ease;
  z-index: 1;
}

/* elevate on hover */
.card:hover {
  transform: translateY(-6px);
  box-shadow: 0 18px 40px rgba(2,6,23,0.12);
}

/* intensify blur automatically for nested cards:
   the inner card will use a larger blur by overriding the variable.
   This provides the "more layers -> more blur" effect you requested. */
.card .card { --card-blur: 14px; }
.card .card .card { --card-blur: 20px; }
.card .card .card .card { --card-blur: 28px; }

/* Headings + small text */
.card h3 {
  margin: 0 0 12px 0;
  color: var(--c3);
  font-size: 15px;
  letter-spacing: 0.2px;
}
.small { font-size:13px; color: rgba(10,20,30,0.55); }

/* left/center/right widths - both dashboard files use .left/.center/.right or .left/.right/.center */
.left { width: 280px; display:flex; flex-direction:column; gap:14px; }
.right { width: 340px; display:flex; flex-direction:column; gap:14px; }
.center { flex:1; display:flex; flex-direction:column; gap:14px; }

/* Table style - translucent rows */
table {
  width:100%;
  border-collapse:collapse;
  border-radius:10px;
  overflow:hidden;
  background: linear-gradient(180deg, rgba(255,255,255,0.68), rgba(255,255,255,0.62));
  box-shadow: 0 6px 18px rgba(2,6,23,0.06);
}
th, td {
  padding:12px 10px;
  text-align:left;
  font-size:14px;
  border-bottom:1px solid rgba(15,23,33,0.06);
}
th {
  background: linear-gradient(90deg, rgba(191,226,242,0.7), rgba(177,213,230,0.6));
  color: #052b3f;
  font-weight:700;
}
tbody tr:hover td {
  background: linear-gradient(90deg, rgba(146,204,232,0.12), rgba(191,226,242,0.08));
  transition: background .18s;
}
.no-data { text-align:center; padding:20px; color: rgba(10,20,30,0.45); }

/* input / select / textarea */
.input, input[type="text"], select, textarea {
  width:100%;
  padding:10px 12px;
  border-radius:10px;
  border:1px solid rgba(2,6,23,0.06);
  background: rgba(255,255,255,0.85);
  font-size:14px;
  transition: box-shadow .12s, border-color .12s;
}
.input:focus, select:focus, textarea:focus {
  outline:none;
  border-color: var(--c3);
  box-shadow: 0 6px 18px rgba(37,150,190,0.09);
}

/* dropdown / role selector glass theme */
.dropdown, .dropdown-btn, .dropdown-content {
  font-family: inherit;
}
.dropdown-btn {
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid rgba(2,6,23,0.06);
  background: rgba(255,255,255,0.9);
  cursor:pointer;
  text-align:left;
}
.dropdown-content {
  background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.86));
  border:1px solid rgba(2,6,23,0.06);
  border-radius:10px;
  padding:10px;
  box-shadow: 0 8px 20px rgba(2,6,23,0.08);
}

/* small components */
.note {
  background: linear-gradient(90deg, rgba(191,226,242,0.9), rgba(177,213,230,0.9));
  border-left: 4px solid var(--c3);
  padding:10px;
  border-radius:8px;
  color: #053447;
}

  /* Chatbox */
  #chatbot {
    display: flex;
    flex-direction: column;
    height: 300px;
    border-radius: 12px;
    background: rgba(255,255,255,0.7);
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    backdrop-filter: blur(10px);
  }
  #chat-header {
    background: var(--primary);
    color: white;
    padding: 10px;
    font-weight: bold;
    text-align: center;
    border-radius: 12px 12px 0 0;
    font-size: 14px;
  }
  #chat-body { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; }
  #chat-input {
    border: none;
    border-top: 1px solid #ddd;
    padding: 10px;
    font-size: 13px;
    border-radius: 0 0 12px 12px;
    outline: none;
  }

/* subtle entrance animations */
@keyframes softFadeUp {
  from { opacity:0; transform: translateY(8px); }
  to   { opacity:1; transform: translateY(0); }
}
.card { animation: softFadeUp .38s ease both; }

/* responsive tweaks */
@media (max-width:1000px){
  .layout, .container { flex-direction:column; gap:14px; padding:14px; }
  .left, .right { width:100%; }
  .topbar { position: sticky; top: 0; z-index: 30; }
}

/* helper: strong contrast button for danger actions (delete) */
.btn-danger {
  background: linear-gradient(135deg, #ff5b6e, #ff7b99);
  color: white;
  border:none;
  padding:8px 10px;
  border-radius:8px;
  cursor:pointer;
  transition: transform .12s;
}
.btn-danger:hover { transform: translateY(-3px); }

/* small utilities */
.km-gap { height: var(--gap); width:100%; display:block; }
</style>

</head>
<body>
  <div class="topbar">
    <div class="greet" id="greet">👋 Welcome, User</div>
    <div><button id="logoutBtn">Logout</button></div>
  </div>

  <div class="layout">
    <!-- Left: Employee / Notifications / Chatbot -->
    <aside class="left">
      <div class="card" id="employeeCard">
        <h3>Employee Details</h3>
        <div><strong id="empName">--</strong></div>
        <div class="small">ID: <span id="empId">--</span></div>
        <div class="small">Role: <span id="empRole">--</span></div>
      </div>

      <div class="card">
        <h3>Notifications</h3>
        <div class="notifications" id="notifications">
          <div class="note">No new notifications</div>
        </div>
      </div>

<div class="card">
  <div id="chatbot">
    <div id="chat-header">🤖 Ameya (AI Assistant)</div>
    <div id="chat-body"></div>
    <input id="chat-input" type="text" placeholder="Type in English / മലയാളം..." 
           onkeypress="if(event.key === 'Enter'){sendMessage();}" />
  </div>
</div>

<style>
#chatbot {
  display: flex;
  flex-direction: column;
  height: 300px;
  border: 1px solid #2596BE;
  border-radius: 8px;
  background: #fff;
}
#chat-header {
  background-color: #2596BE;
  color: rgb(193, 222, 231);
  padding: 8px;
  font-weight: bold;
  text-align: center;
  border-radius: 8px 8px 0 0;
  font-size: 14px;
}
#chat-body {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  font-size: 13px;
  line-height: 1.4;
}
#chat-input {
  border: none;
  border-top: 1px solid #ccc;
  padding: 8px;
  font-size: 13px;
  outline: none;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const API_URL = "http://127.0.0.1:5005/webhooks/rest/webhook";
  const chatMessages = document.getElementById("chat-body");
  const userInput = document.getElementById("chat-input");
  const senderId = "user_" + Date.now(); // unique per session

  async function sendMessage() {
    const message = userInput.value.trim();
    if (!message) return;

    appendMessage("You", message);
    userInput.value = "";

    try {
      const response = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sender: senderId, message })
      });

      const data = await response.json();
      if (data && data.length > 0) {
        data.forEach((msg) => {
          if (msg.text) appendMessage("Ameya", msg.text);
        });
      } else {
        appendMessage("Ameya", "🤔 I didn’t understand that.");
      }
    } catch (error) {
      appendMessage("Ameya", "⚠️ Error connecting to server.");
      console.error("Error:", error);
    }
  }

  function appendMessage(sender, text) {
    const msgDiv = document.createElement("div");
    msgDiv.innerHTML = `<b>${sender}:</b> ${text}`;
    chatMessages.appendChild(msgDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // expose function globally so HTML onclick works
  window.sendMessage = sendMessage;
});
</script>
    </aside>

    <!-- Center: Documents list -->
    <main class="center">
      <div class="card">
        <h3>Available Documents</h3>
        <input type="text" id="searchInput" class="input" placeholder="🔍 Quick Search by Title or Department" />
        <div style="overflow:auto; margin-top:10px;">
          <table id="docsTable">
            <thead>
              <tr>
                <th>Name</th>
                <th>Department</th>
                <th>Uploaded By</th>
                <th>Date</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="docsTbody">
              <tr><td class="no-data" colspan="5">Loading documents…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- Right: Quick Search info (optional tips or filters) -->
    <aside class="right">
  <!-- Quick Search Tips -->
  <div class="card">
    <h3>Quick Search Tips</h3>
    <p class="small">You can search by document title or department above.</p>
  </div>

  <!-- To-Do Card -->
  <div class="card">
    <h3>📝 My To-Do</h3>
    <input type="text" id="todoInput" class="input" placeholder="Add a new task" />
    <button id="addTodoBtn" style="background:var(--primary); color:white; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">Add Task</button>
    <ul id="todoList" style="list-style:none; padding-left:0; margin-top:10px;"></ul>
  </div>
</aside>

  </div>

<script>
const API_BASE = "http://127.0.0.1:8000";
const token = localStorage.getItem("token");
const username = localStorage.getItem("username") || "User";

/* DOM refs */
const greet = document.getElementById("greet");
const logoutBtn = document.getElementById("logoutBtn");
const empName = document.getElementById("empName");
const empId = document.getElementById("empId");
const empRole = document.getElementById("empRole");
const notifications = document.getElementById("notifications");

const docsTbody = document.getElementById("docsTbody");
const searchInput = document.getElementById("searchInput");

if (!token) {
  window.location.href = "login.html";
} else {
  greet.innerText = `👋 Welcome, ${username}`;
}

/* Logout */
logoutBtn.addEventListener("click", () => {
  localStorage.removeItem("token");
  localStorage.removeItem("username");
  window.location.href = "login.html";
});

/* Fetch employee details */
async function loadEmployeeDetails() {
  try {
    const res = await fetch(`${API_BASE}/auth/me`, { headers: { "Authorization": "Bearer " + token } });
    if (res.ok) {
      const u = await res.json();
      empName.innerText = u.full_name || u.username || username;
      empId.innerText = u.id || u.employee_id || "--";
      empRole.innerText = u.role || "--";
    } else {
      console.warn("Failed to fetch employee details:", res.status);
    }
  } catch (err) {
    console.warn("Employee details error:", err);
  }
}

/* Notifications */
function loadNotifications() {
  const notificationsEl = notifications;
  if (!notificationsEl) return;

  const hardcodedList = [
    "📢 New document uploaded",
    "✅ Your file has been approved",
    "⚠️ Pending review on your last upload"
  ];

  notificationsEl.innerHTML = "";
  if (!hardcodedList.length) {
    notificationsEl.innerHTML = `<div class="note">No new notifications</div>`;
    return;
  }

  hardcodedList.slice(0, 6).forEach(msg => {
    const div = document.createElement("div");
    div.className = "note";
    div.textContent = msg;
    notificationsEl.appendChild(div);
  });
}

/* Fetch documents */
let allDocs = [];
async function fetchDocuments() {
  docsTbody.innerHTML = `<tr><td class="no-data" colspan="4">Loading…</td></tr>`;
  try {
    const res = await fetch(`${API_BASE}/documents/documents/list`, { headers: { "Authorization": "Bearer " + token } });
    if (!res.ok) {
      docsTbody.innerHTML = `<tr><td class="no-data" colspan="4">Failed to load documents</td></tr>`;
      return;
    }
    allDocs = await res.json();
    renderDocs(allDocs);
  } catch (err) {
    docsTbody.innerHTML = `<tr><td class="no-data" colspan="4">Network error</td></tr>`;
  }
}

/* Render filtered documents */
function renderDocs(docs) {
  docsTbody.innerHTML = "";
  if (!docs.length) {
    docsTbody.innerHTML = `<tr><td class="no-data" colspan="4">No documents uploaded yet.</td></tr>`;
    return;
  }
  docs.forEach(d => {
    const date = d.uploaded_at?.split("T")[0] || "--";
    const title = escapeHtml(d.title || d.filename || "Unnamed");
    const uploadedBy = escapeHtml(d.uploaded_by || "—");

    docsTbody.innerHTML += `
      <tr>
        <td>${title}</td>
        <td>${uploadedBy}</td>
        <td>${date}</td>
        <td><a href="document.html?id=${d.id}" target="_blank">Open</a></td>
      </tr>
    `;
  });
}

/* Quick search by title only */
searchInput.addEventListener("input", () => {
  const val = searchInput.value.toLowerCase();
  const filtered = allDocs.filter(d => (d.title || "").toLowerCase().includes(val));
  renderDocs(filtered);
});

/* Escape html */
function escapeHtml(str) {
  return String(str || "").replace(/[&<>"']/g, m => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[m]));
}

/* ----- To-Do Functionality ----- */
const todoInput = document.getElementById("todoInput");
const addTodoBtn = document.getElementById("addTodoBtn");
const todoList = document.getElementById("todoList");

// Load todos from localStorage
let todos = JSON.parse(localStorage.getItem("todos") || "[]");

function renderTodos() {
  todoList.innerHTML = "";
  if (!todos.length) {
    todoList.innerHTML = "<li style='color:var(--muted)'>No tasks added</li>";
    return;
  }

  todos.forEach((task, index) => {
    const li = document.createElement("li");
    li.style.display = "flex";
    li.style.justifyContent = "space-between";
    li.style.alignItems = "center";
    li.style.padding = "6px 0";

    li.innerHTML = `
      <span>${escapeHtml(task)}</span>
      <button style="background:red;color:white;border:none;padding:2px 6px;border-radius:4px;cursor:pointer;">❌</button>
    `;

    li.querySelector("button").addEventListener("click", () => {
      todos.splice(index, 1);
      localStorage.setItem("todos", JSON.stringify(todos));
      renderTodos();
    });

    todoList.appendChild(li);
  });
}

// Add new todo
addTodoBtn.addEventListener("click", () => {
  const task = todoInput.value.trim();
  if (task) {
    todos.push(task);
    localStorage.setItem("todos", JSON.stringify(todos));
    todoInput.value = "";
    renderTodos();
  }
});

/* Initialize all */
loadEmployeeDetails();
loadNotifications();
fetchDocuments();
renderTodos();

</script>
</body>
</html>
