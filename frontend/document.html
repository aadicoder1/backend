<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Document - KMRL SmartDocs</title>
  <style>
    :root{
      --blue:#005baa;
      --blue-dark:#004080;
      --green:#008c4a;
      --green-dark:#006837;
      --orange:#ff9800;
      --orange-dark:#e68900;
      --gray:#ccc;
      --gray-dark:#aaa;
    }
    body{
      margin:0;
      font-family:Arial, sans-serif;
      background:#f5f7fa;
      min-height:100vh;
      display:grid;
      place-items:center;
    }
    .container{
      background:#fff;
      padding:30px;
      border-radius:12px;
      box-shadow:0 4px 15px rgba(0,0,0,.2);
      text-align:center;
      width:min(560px, 92vw);
    }
    h2{ color:var(--blue); margin:0 0 20px }
    .btn{
      display:block; width:100%;
      padding:12px; margin:10px 0;
      border:none; border-radius:8px;
      cursor:pointer; font-size:16px;
      transition:.2s ease;
      text-decoration:none; text-align:center;
    }
    .btn.open{ background:var(--blue); color:#fff }
    .btn.open:hover{ background:var(--blue-dark) }
    .btn.summarize{ background:var(--green); color:#fff }
    .btn.summarize:hover{ background:var(--green-dark) }
    .btn.access{ background:var(--orange); color:#fff }
    .btn.access:hover{ background:var(--orange-dark) }
    .btn.close{ background:var(--gray); color:#000 }
    .btn.close:hover{ background:var(--gray-dark) }
    .pill{
      display:inline-block; padding:4px 10px; margin:4px;
      border-radius:999px; background:#e8f1ff; color:var(--blue);
      font-size:12px; border:1px solid #cfe0ff;
    }
    /* Modal */
    .modal{
      position:fixed; inset:0;
      background:rgba(0,0,0,.5);
      display:none;
      align-items:center; justify-content:center;
      z-index:9999;
      padding:16px;
    }
    .modal.show{ display:flex }
    .modal-card{
      width:min(520px, 96vw);
      background:#fff; border-radius:12px;
      box-shadow:0 8px 28px rgba(0,0,0,.35);
      padding:20px;
    }
    .modal-card h3{ margin:0 0 10px; color:var(--blue) }
    .roles{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:6px 14px; margin:8px 0 4px }
    .row{ margin:12px 0 6px; font-weight:bold }
    .footer{ display:flex; justify-content:flex-end; gap:10px; margin-top:14px }
    .summary-text{ white-space:pre-wrap; text-align:left; background:#f8f9fc; padding:10px; border-radius:6px; max-height:300px; overflow-y:auto }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="docTitle">Document</h2>

    <a id="openBtn" class="btn open" target="_blank" rel="noopener">üìÇ Open Document</a>
    <button class="btn summarize" onclick="summarizeDoc()">üìÑ Summarize</button>
    <button class="btn access" onclick="openAccessModal()">üîë Give Access</button>
    <button class="btn close" onclick="closeDoc()">‚ùå Close</button>

    <div id="currentAccess" style="margin-top:8px;"></div>
  </div>

  <!-- Access Modal -->
  <div id="accessModal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="accessTitle">
      <h3 id="accessTitle">Give Access</h3>

      <div class="row">Option 1: Let AI decide roles</div>
      <button class="btn summarize" id="aiBtn">ü§ñ AI Suggest</button>

      <div class="row">Option 2: Manually select roles</div>
      <div class="roles" id="rolesBox">
        <label><input type="checkbox" value="Admin"> Admin</label>
        <label><input type="checkbox" value="HR Executive"> HR Executive</label>
        <label><input type="checkbox" value="Engineer"> Engineer</label>
        <label><input type="checkbox" value="Manager"> Manager</label>
        <label><input type="checkbox" value="Staff"> Staff</label>
        <label><input type="checkbox" value="Finance"> Finance</label>
      </div>

      <div class="footer">
        <button class="btn close" id="cancelBtn">Cancel</button>
        <button class="btn open" id="saveBtn">Save</button>
      </div>
    </div>
  </div>

  <!-- Summary Modal -->
  <div id="summaryModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h3>üìÑ Document Summary</h3>
      <div id="summaryContent" class="summary-text">Loading...</div>
      <div class="footer">
        <button class="btn close" onclick="closeSummary()">Close</button>
      </div>
    </div>
  </div>

  <script>
  // ---- Setup ----
  const params = new URLSearchParams(window.location.search);
  const docId = params.get("id") || "Unknown";

  const titleEl = document.getElementById("docTitle");
  const openBtn = document.getElementById("openBtn");
  const currentAccess = document.getElementById("currentAccess");
  const rolesBox = document.getElementById("rolesBox");

  let currentDoc = null;

  async function loadDocument() {
    if (docId === "Unknown") {
      titleEl.textContent = "‚ùå Invalid Document";
      openBtn.href = "#";
      return;
    }

    try {
      const res = await fetch(`http://127.0.0.1:8000/documents/list`);
      const docs = await res.json();
      currentDoc = docs.find(d => d.id == docId);

      if (!currentDoc) {
        titleEl.textContent = "‚ùå Document not found";
        openBtn.href = "#";
        return;
      }

      titleEl.textContent = currentDoc.title || ("Document ID: " + docId);
      openBtn.href = `http://127.0.0.1:8000/documents/${docId}`;

      renderCurrentAccess();
    } catch (err) {
      console.error("Failed to load document:", err);
      titleEl.textContent = "‚ö†Ô∏è Error loading document";
    }
  }
  loadDocument();

  // ---- Summary ----
  async function summarizeDoc() {
    if (!currentDoc) return alert("‚ö†Ô∏è Summary unavailable");

    try {
      const res = await fetch(`http://127.0.0.1:8000/summarize/${docId}`);
      if (!res.ok) throw new Error("Failed to summarize");

      const data = await res.json();
      document.getElementById("summaryContent").textContent = data.summary;
      document.getElementById("summaryModal").classList.add("show");
    } catch (err) {
      alert("Error: " + err.message);
    }
  }

  function closeSummary(){
    document.getElementById("summaryModal").classList.remove("show");
  }

  // ---- Access modal controls ----
  const modal = document.getElementById("accessModal");
  const aiBtn = document.getElementById("aiBtn");
  const cancelBtn = document.getElementById("cancelBtn");
  const saveBtn = document.getElementById("saveBtn");

  function openAccessModal() {
    modal.classList.add("show");
    modal.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
    loadSavedRoles();
  }
  function closeAccessModal() {
    modal.classList.remove("show");
    modal.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
  }
  window.openAccessModal = openAccessModal;

  cancelBtn.addEventListener("click", closeAccessModal);
  modal.addEventListener("click", (e)=>{
    if(e.target === modal) closeAccessModal();
  });

  aiBtn.addEventListener("click", ()=>{
    const name = (currentDoc?.title || "").toLowerCase();
    const suggestion = new Set();
    if (name.includes("safety")) suggestion.add("Staff"), suggestion.add("Manager");
    if (name.includes("employee") || name.includes("guidelines")) suggestion.add("HR Executive"), suggestion.add("Manager");
    if (name.includes("budget")) suggestion.add("Finance"), suggestion.add("Admin");
    if (name.includes("annual") || name.includes("report")) suggestion.add("Admin"), suggestion.add("Manager");
    if (name.includes("expansion") || name.includes("plan")) suggestion.add("Engineer"), suggestion.add("Manager");
    if (suggestion.size === 0) suggestion.add("Admin");
    Array.from(rolesBox.querySelectorAll('input[type="checkbox"]')).forEach(cb=>{
      cb.checked = suggestion.has(cb.value);
    });
  });

  function saveAccess() {
    const selected = Array.from(rolesBox.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(cb => cb.value);
    localStorage.setItem(`doc_access_${docId}`, JSON.stringify(selected));
    renderCurrentAccess();
    alert("‚úÖ Access saved for Document " + docId);
    closeAccessModal();
  }
  saveBtn.addEventListener("click", saveAccess);

  function loadSavedRoles() {
    const saved = JSON.parse(localStorage.getItem(`doc_access_${docId}`) || "[]");
    Array.from(rolesBox.querySelectorAll('input[type="checkbox"]')).forEach(cb=>{
      cb.checked = saved.includes(cb.value);
    });
  }

  function renderCurrentAccess() {
    const saved = JSON.parse(localStorage.getItem(`doc_access_${docId}`) || "[]");
    if (saved.length === 0){
      currentAccess.innerHTML = `<small><em>No access roles set yet.</em></small>`;
      return;
    }
    currentAccess.innerHTML = `<div style="margin-top:12px;text-align:left">
      <strong>Current access:</strong> ${saved.map(r=>`<span class="pill">${r}</span>`).join("")}
    </div>`;
  }

  function closeDoc(){ window.location.href = "dashboard.html"; }
  window.closeDoc = closeDoc;
  </script>
</body>
</html>
